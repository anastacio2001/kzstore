/**
 * KZSTORE AI Chatbot Service
 * Integra√ß√£o com Google Gemini AI
 */

const GEMINI_API_KEY = import.meta.env.VITE_GEMINI_API_KEY || '';
const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent';

// Importar servi√ßo de produtos
import * as productsService from './productsService';

export interface ChatMessage {
  role: 'user' | 'assistant';
  content: string;
  timestamp: string;
}

/**
 * Obter contexto da loja (produtos, categorias, etc.)
 */
async function getStoreContext(): Promise<string> {
  try {
    const products = await productsService.getAllProducts();
    
    // Agrupar por categoria
    const categories = [...new Set(products.map(p => p.categoria))];
    
    const context = `
INFORMA√á√ïES DA LOJA:
- Nome: KZSTORE
- Especialidade: Produtos eletr√¥nicos e componentes de TI
- Categorias: ${categories.join(', ')}
- Total de produtos: ${products.length}
- Formas de pagamento: Multicaixa Express, Transfer√™ncia Banc√°ria, TPA
- Entrega: 2-3 dias √∫teis em Luanda
- WhatsApp: +244931054015

PRINCIPAIS PRODUTOS:
${products.slice(0, 10).map(p => `- ${p.nome}: ${p.preco.toLocaleString('pt-AO')} Kz (${p.estoque > 0 ? 'Dispon√≠vel' : 'Esgotado'})`).join('\n')}
    `.trim();
    
    return context;
  } catch (error) {
    console.error('Error getting store context:', error);
    return 'KZSTORE - Loja de eletr√¥nicos em Angola';
  }
}

/**
 * Envia mensagem para o Gemini AI
 */
export async function sendChatMessage(
  userMessage: string,
  conversationHistory: ChatMessage[] = []
): Promise<string> {
  try {
    // Verificar se API key est√° configurada
    if (!GEMINI_API_KEY || GEMINI_API_KEY.trim() === '') {
      console.warn('‚ö†Ô∏è Gemini API key not configured');
      throw new Error('GEMINI_API_KEY_NOT_CONFIGURED');
    }

    console.log('ü§ñ Sending message to Gemini AI...');

    // Obter contexto da loja
    const storeContext = await getStoreContext();

    // Montar hist√≥rico de conversa
    const history = conversationHistory.slice(-5).map(msg => ({
      role: msg.role === 'user' ? 'user' : 'model',
      parts: [{ text: msg.content }]
    }));

    // System prompt
    const systemPrompt = `Voc√™ √© um assistente virtual inteligente da KZSTORE, a principal loja online de Angola especializada em tecnologia e eletr√¥nicos de qualidade.

${storeContext}

üéØ PERSONALIDADE E TOM:
- Profissional, mas amig√°vel e acess√≠vel
- Entusiasta de tecnologia, mas n√£o t√©cnico demais
- Confiante nas solu√ß√µes que oferece
- Emp√°tico com as necessidades do cliente
- Use portugu√™s de Angola (evite brasileirismos)

üìã DIRETRIZES IMPORTANTES:

1. **PRODUTOS E PRE√áOS:**
   - Sempre sugira produtos espec√≠ficos com pre√ßos em Kwanzas (Kz)
   - Indique claramente a disponibilidade (‚úÖ Em estoque / ‚è≥ Sob encomenda / ‚ùå Esgotado)
   - Mencione garantia quando relevante
   - Compare op√ß√µes quando apropriado (bom, melhor, premium)

2. **PAGAMENTO:**
   - Formas aceitas: Multicaixa Express, Transfer√™ncia Banc√°ria, TPA
   - Pagamento seguro e facilitado
   - Possibilidade de negocia√ß√£o para grandes quantidades

3. **ENTREGA:**
   - Luanda: 2-3 dias √∫teis
   - Outras prov√≠ncias: 5-7 dias √∫teis
   - Entregas rastre√°veis
   - Embalagem segura

4. **ATENDIMENTO HUMANO:**
   - Para pedidos, negocia√ß√µes ou d√∫vidas complexas, sempre sugira WhatsApp
   - N√∫mero: +244 931 054 015
   - Hor√°rio: Segunda a S√°bado, 8h √†s 18h

5. **ESTILO DE RESPOSTA:**
   - M√°ximo 4 par√°grafos curtos
   - Use emojis estrategicamente (n√£o exagere)
   - Estruture com bullets quando listar produtos
   - Sempre finalize com uma pergunta ou call-to-action

6. **SITUA√á√ïES ESPECIAIS:**
   - Produto esgotado: Sugira alternativas similares
   - D√∫vida t√©cnica complexa: Recomende WhatsApp
   - Pre√ßo n√£o dispon√≠vel: Sugira contato direto
   - Quantidade grande: Mencione possibilidade de desconto

‚ú® EXEMPLO DE RESPOSTA PERFEITA:

"Excelente escolha! üëç Temos √≥timas op√ß√µes de SSD NVMe com pre√ßos competitivos:

**Op√ß√µes Dispon√≠veis:**
‚Ä¢ Kingston NV2 256GB - 18.500 Kz ‚úÖ Em estoque
‚Ä¢ WD Blue SN570 500GB - 32.000 Kz ‚úÖ Em estoque
‚Ä¢ Samsung 980 PRO 1TB - 65.000 Kz ‚úÖ Em estoque

Todos com 3 anos de garantia e entrega em 2-3 dias em Luanda! üöö

Para qual uso vai precisar? Gaming, edi√ß√£o de v√≠deo ou uso geral?"

üö´ EVITE:
- Informa√ß√µes que voc√™ n√£o tem certeza
- Promessas que n√£o pode cumprir
- Respostas gen√©ricas sem mencionar produtos
- Textos muito longos e cansativos
`;

    // Fazer requisi√ß√£o para Gemini API
    const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        contents: [
          {
            role: 'user',
            parts: [{ text: systemPrompt }]
          },
          ...history,
          {
            role: 'user',
            parts: [{ text: userMessage }]
          }
        ],
        generationConfig: {
          temperature: 0.7,
          topK: 40,
          topP: 0.95,
          maxOutputTokens: 500
        },
        safetySettings: [
          {
            category: 'HARM_CATEGORY_HARASSMENT',
            threshold: 'BLOCK_MEDIUM_AND_ABOVE'
          },
          {
            category: 'HARM_CATEGORY_HATE_SPEECH',
            threshold: 'BLOCK_MEDIUM_AND_ABOVE'
          }
        ]
      })
    });

    if (!response.ok) {
      const errorData = await response.text();
      console.error('‚ùå Gemini API error:', errorData);
      throw new Error(`Gemini API error: ${response.status}`);
    }

    const data = await response.json();

    // Extrair resposta
    const aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text;

    if (!aiResponse) {
      throw new Error('No response from Gemini AI');
    }

    console.log('‚úÖ Gemini AI response received');
    return aiResponse.trim();

  } catch (error) {
    console.error('‚ùå Error in Gemini AI service:', error);
    
    // Resposta de fallback
    return `Desculpe, estou com dificuldades t√©cnicas no momento. üòÖ

Por favor, entre em contato diretamente via WhatsApp +244931054015 para atendimento imediato.

Nossa equipe est√° pronta para ajudar com:
‚Ä¢ Consulta de produtos e pre√ßos
‚Ä¢ Informa√ß√µes sobre estoque
‚Ä¢ Processamento de pedidos
‚Ä¢ Suporte t√©cnico

Hor√°rio de atendimento: Segunda a S√°bado, 8h √†s 18h`;
  }
}

/**
 * Busca produtos por consulta
 */
export async function searchProducts(query: string): Promise<any[]> {
  try {
    const products = await productsService.getAllProducts();
    
    const searchTerms = query.toLowerCase().split(' ');
    
    return products.filter(product => {
      const searchableText = `
        ${product.nome} 
        ${product.descricao} 
        ${product.categoria} 
        ${product.subcategoria}
        ${JSON.stringify(product.especificacoes || {})}
      `.toLowerCase();
      
      return searchTerms.some(term => searchableText.includes(term));
    }).slice(0, 5);
  } catch (error) {
    console.error('Error searching products:', error);
    return [];
  }
}

/**
 * Gera sugest√µes de produtos baseado na consulta do usu√°rio
 */
export async function getProductSuggestions(userMessage: string): Promise<string> {
  try {
    const products = await searchProducts(userMessage);
    
    if (products.length === 0) {
      return '';
    }

    const suggestions = products.map(p => 
      `‚Ä¢ **${p.nome}** - ${p.preco.toLocaleString('pt-AO')} Kz ${p.estoque > 0 ? '‚úÖ' : '‚ùå Esgotado'}`
    ).join('\n');

    return `\n\n**Produtos relacionados:**\n${suggestions}`;
  } catch (error) {
    console.error('Error getting product suggestions:', error);
    return '';
  }
}

console.log('‚úÖ Gemini AI Service initialized');