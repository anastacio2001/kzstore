/**
 * Sistema de Autentica√ß√£o Local Tempor√°rio
 *
 * IMPORTANTE: Este √© um sistema TEMPOR√ÅRIO para resolver o problema de login
 * sem depender do Supabase. Em produ√ß√£o, deve ser substitu√≠do por JWT.
 *
 * Funcionalidades:
 * - Login simples com email (sem senha por enquanto)
 * - Persist√™ncia no localStorage
 * - Gera√ß√£o de user_id √∫nico
 * - Compat√≠vel com o sistema atual
 */

import { useState, useEffect } from 'react';

type LocalUser = {
  id: string;
  email: string;
  name: string;
  phone?: string;
  role: 'customer' | 'admin';
  created_at: string;
};

const STORAGE_KEY = 'kzstore_local_users';
const SESSION_KEY = 'kzstore_local_session';

/**
 * Gera um ID √∫nico e consistente para o usu√°rio baseado no email
 * Se o usu√°rio j√° existe, retorna o mesmo ID
 */
function generateUserId(email: string): string {
  // Verificar se j√° existe ID para este email
  const savedUsers = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');

  if (savedUsers[email]?.id) {
    return savedUsers[email].id;
  }

  // Gerar novo ID baseado no email (consistente)
  const hash = email.split('').reduce((acc, char) => {
    return char.charCodeAt(0) + ((acc << 5) - acc);
  }, 0);

  // Usar hash + timestamp para garantir unicidade
  return `local_${Math.abs(hash).toString(36)}_${Date.now().toString(36)}`;
}

/**
 * Verifica se o email √© de admin
 */
function isAdminEmail(email: string): boolean {
  const adminEmails = [
    'admin@kzstore.ao',
    'admin@kzstore.com',
    'geral@kzstore.com',
    'geral@kzstore.ao'
  ];
  return adminEmails.includes(email.toLowerCase());
}

export function useLocalAuth() {
  const [user, setUser] = useState<LocalUser | null>(() => {
    // Tentar carregar sess√£o salva
    const savedSession = localStorage.getItem(SESSION_KEY);
    if (savedSession) {
      try {
        const session = JSON.parse(savedSession);
        console.log('üîµ [useLocalAuth] Loading session from localStorage:', session.email);
        return session;
      } catch (error) {
        console.error('‚ùå [useLocalAuth] Error parsing session:', error);
        localStorage.removeItem(SESSION_KEY);
      }
    }
    return null;
  });

  const [isAuthenticated, setIsAuthenticated] = useState(() => !!user);

  // Salvar sess√£o quando o usu√°rio mudar
  useEffect(() => {
    if (user) {
      console.log('üíæ [useLocalAuth] Saving session:', user.email);
      localStorage.setItem(SESSION_KEY, JSON.stringify(user));
      setIsAuthenticated(true);
    } else {
      console.log('üóëÔ∏è [useLocalAuth] Clearing session');
      localStorage.removeItem(SESSION_KEY);
      setIsAuthenticated(false);
    }
  }, [user]);

  /**
   * Login simples com email
   */
  const loginWithEmail = async (email: string, name?: string): Promise<LocalUser> => {
    console.log('üîµ [useLocalAuth] Login with email:', email);

    // Verificar se j√° existe usu√°rio salvo com este email
    const savedUsers = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');

    let userData: LocalUser;

    if (savedUsers[email]) {
      // Usu√°rio j√° existe
      console.log('‚úÖ [useLocalAuth] User found in storage');
      userData = savedUsers[email];
    } else {
      // Criar novo usu√°rio
      console.log('üÜï [useLocalAuth] Creating new user');
      userData = {
        id: generateUserId(email),
        email,
        name: name || email.split('@')[0],
        role: isAdminEmail(email) ? 'admin' : 'customer',
        created_at: new Date().toISOString()
      };

      // Salvar novo usu√°rio
      savedUsers[email] = userData;
      localStorage.setItem(STORAGE_KEY, JSON.stringify(savedUsers));
    }

    // Atualizar nome se fornecido
    if (name && userData.name !== name) {
      userData.name = name;
      savedUsers[email] = userData;
      localStorage.setItem(STORAGE_KEY, JSON.stringify(savedUsers));
    }

    console.log('‚úÖ [useLocalAuth] Login successful:', userData.email, 'ID:', userData.id);
    setUser(userData);
    // Dispatch global auth change for other listeners
    if (typeof window !== 'undefined') {
      window.dispatchEvent(new CustomEvent('kzstore:authChange', { detail: { id: userData.id, email: userData.email, role: userData.role, name: userData.name, phone: userData.phone } }));
    }
    return userData;
  };

  /**
   * Login r√°pido para checkout (guest ou registrado)
   * Usa o backend para criar/buscar usu√°rio
   */
  const quickLogin = async (email: string, name: string, phone?: string): Promise<LocalUser> => {
    console.log('‚ö° [useLocalAuth] Quick login request:', email);

    try {
      const response = await fetch('/api/auth/quick-login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, name, phone })
      });

      if (!response.ok) {
        throw new Error('Quick login failed');
      }

      const data = await response.json();
      console.log('‚úÖ [useLocalAuth] Quick login successful:', data.user.email);

      const userData: LocalUser = {
        id: data.user.id,
        email: data.user.email,
        name: data.user.name,
        phone: data.user.phone,
        role: data.user.role,
        created_at: new Date().toISOString()
      };

      setUser(userData);
      // Dispatch global auth change for other listeners
      if (typeof window !== 'undefined') {
        window.dispatchEvent(new CustomEvent('kzstore:authChange', { detail: { id: userData.id, email: userData.email, role: userData.role, name: userData.name, phone: userData.phone } }));
      }
      return userData;
    } catch (error) {
      console.error('‚ùå [useLocalAuth] Quick login error:', error);
      // Fallback para m√©todo local
      return await loginWithEmail(email, name);
    }
  };

  /**
   * Logout
   */
  const logout = () => {
    console.log('üîµ [useLocalAuth] Logout');
    setUser(null);
    if (typeof window !== 'undefined') {
      window.dispatchEvent(new CustomEvent('kzstore:authChange', { detail: null }));
    }
  };

  /**
   * Verificar se √© admin
   */
  const isAdmin = () => {
    return user?.role === 'admin';
  };

  /**
   * Atualizar dados do usu√°rio
   */
  const updateUser = (updates: Partial<LocalUser>) => {
    if (!user) return;

    const updatedUser = { ...user, ...updates };
    const savedUsers = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
    savedUsers[user.email] = updatedUser;
    localStorage.setItem(STORAGE_KEY, JSON.stringify(savedUsers));
    setUser(updatedUser);
  };

  return {
    user,
    isAuthenticated,
    isAdmin,
    loginWithEmail,
    quickLogin,
    logout,
    updateUser
  };
}
